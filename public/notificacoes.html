<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificações</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="css/calendario.css">
    <link rel="stylesheet" href="css/notificacoes.css">
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/scheduler/edge/dhtmlxscheduler.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.dhtmlx.com/scheduler/edge/dhtmlxscheduler.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
</head>
<body>

    <header class="top-bar">
        <div class="header-left">
            <span class="sepa-title">SEPA - CALENDÁRIO ACADÊMICO</span>
        </div>
    </header>


    <div class="main-layout">
        <div class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="calendario2.html" data-tooltip="Calendário"><i class="fas fa-calendar-alt"></i><span class="menu-text">Calendário</span></a></li>
                    <li><a href="perfil.html" data-tooltip="Meu Perfil"><i class="fas fa-user"></i><span class="menu-text">Perfil</span></a></li>
                    <li><a href="notificacoes.html" class="active" data-tooltip="Notificações"><i class="fas fa-bell"></i><span class="menu-text">Notificações</span></a></li>
                    <li><a href="calendario.html" data-tooltip="Tabela de Aulas"><i class="fas fa-table"></i><span class="menu-text">Tabela</span></a></li>
                </ul>
                <div class="sidebar-footer">
                    <a onclick="sair(event); return false;" href="#" data-tooltip="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="menu-text">Sair</span>
                    </a>
                </div>
            </nav>
        </div>


    <div class="main-container">
    <div id="profile-container">
        <img id="profilePic" src="img/default.png" alt="Foto de Perfil">
        <div>
            <p id="userName"></p>
            <p id="userRole"></p>
        </div>
    </div>
          

    <div id="listaNotificacoes"></div>

    <script>
        async function carregarDadosUsuario() {
          try {
                const response = await fetch('/getUserData');
                if (!response.ok) throw new Error("Não autenticado");
                
                const data = await response.json();

                document.getElementById('userName').innerText = data.nome;
                document.getElementById('userRole').innerText = data.tipo;
                if (data.profilePic) {
                    document.getElementById('profilePic').src = '/img/' + data.profilePic;
                } else {
                    document.getElementById('profilePic').src = '/img/default.png';
                }
                
                if (data.foto) {
                    document.getElementById('profilePic').src = data.foto;
                }
                carregarNotificacoes();
                } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                alert('Erro ao carregar perfil.');
            }
        }
        
        async function carregarNotificacoes() {
  const notificacoesDiv = document.getElementById('listaNotificacoes');
  
  try {
    // Mostrar estado de carregamento
    notificacoesDiv.innerHTML = '<div class="loading"><p>Carregando notificações...</p></div>';

    const response = await fetch('/api/notificacoes', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      credentials: 'include'
    });

    // Verificação robusta do tipo de conteúdo
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error('O servidor retornou um formato inesperado');
    }

    if (!response.ok) {
      const error = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
      throw new Error(error.message || `Erro ${response.status}`);
    }

    const aulas = await response.json();
    exibirNotificacoes(aulas);
  } catch (error) {
    console.error("Erro ao carregar notificações:", error);
    notificacoesDiv.innerHTML = `
      <div class="notificacao erro">
        <p>Erro ao carregar notificações</p>
        <small>${escapeHtml(error.message)}</small>
      </div>
    `;
  }
}

// Função para escapar HTML (prevenção XSS)
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Função para exibir as notificações na página
function exibirNotificacoes(aulas) {
  const notificacoesDiv = document.getElementById('listaNotificacoes');
  notificacoesDiv.innerHTML = '';

  if (aulas.length === 0) {
    notificacoesDiv.innerHTML = `
      <div class="notificacao">
        <p>Nenhuma aula programada</p>
        <small>Não há aulas agendadas no momento</small>
      </div>
    `;
    return;
  }

  aulas.forEach(aula => {
    const noti = document.createElement('div');
    noti.classList.add('notificacao');
    
    noti.innerHTML = `
      <div class="notificacao-cabecalho">
        <h4>${aula.materia}</h4>
        <span class="notificacao-data">${aula.data}</span>
      </div>
      <div class="notificacao-corpo">
        <p><i class="far fa-clock"></i> ${aula.hora_inicio} - ${aula.hora_fim}</p>
        <p><i class="fas fa-map-marker-alt"></i> ${aula.localizacao || 'Local não informado'}</p>
        ${aula.dias_semana ? `<p><i class="far fa-calendar-alt"></i> ${aula.dias_semana}</p>` : ''}
        ${aula.professor ? `<p><i class="fas fa-chalkboard-teacher"></i> ${aula.professor}</p>` : ''}
      </div>
      <div class="notificacao-rodape">
        <span class="turno ${aula.turno.toLowerCase()}">${aula.turno}</span>
      </div>
    `;

    notificacoesDiv.appendChild(noti);
  });
}

// Atualizar notificações a cada 5 minutos
setInterval(carregarNotificacoes, 5 * 60 * 1000);

// Carregar ao iniciar
document.addEventListener('DOMContentLoaded', carregarNotificacoes);

        function sair() {
        if (confirm("Você tem certeza que deseja sair?")) {
            fetch('https://sepa-api.onrender.com/', { method: 'POST' })
                .then(() => {
                    window.location.href = 'home.html';
                })
                .catch(error => {
                    console.error('Erro ao sair:', error);
                    alert('Erro ao fazer logout.');
                });
        }}
    </script>
</body>
</html>